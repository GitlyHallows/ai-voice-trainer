<!DOCTYPE html>
<html>
<head>
  <title>Minimal Voice Test</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
    button { padding: 10px; margin: 10px 0; }
    #log { 
      font-family: monospace; 
      white-space: pre-wrap; 
      background: #f0f0f0; 
      padding: 10px; 
      margin-top: 10px;
      max-height: 400px;
      overflow-y: auto;
    }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Minimal Voice Test</h1>
  <div>
    <button onclick="testVoice()">Test Voice</button>
    <button onclick="testDirectFetch()">Test API Only</button>
    <button onclick="testAudioOnly()">Test Audio Only</button>
  </div>
  <div id="log"></div>

  <script>
    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const time = new Date().toISOString().split('T')[1].split('.')[0];
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      const entry = document.createElement('div');
      entry.className = className;
      entry.textContent = `[${time}] ${msg}`;
      logEl.insertBefore(entry, logEl.firstChild);
      console.log(`[${type}]`, msg);
    }

    // Test just the API call
    async function testDirectFetch() {
      const apiKey = 'sk_f0273b3cafb56f7270e2ac6f91d37b60b821a99d6a28feef';
      const voiceId = '21m00Tcm4TlvDq8ikWAM';
      const text = 'This is a test of the API connection.';

      try {
        log('Making direct API request...');
        const response = await fetch(
          `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`,
          {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': apiKey
            },
            body: JSON.stringify({
              text,
              model_id: 'eleven_monolingual_v1',
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.75
              }
            })
          }
        );

        log(`Response status: ${response.status} ${response.statusText}`);
        log('Response headers:', 'info');
        for (const [key, value] of response.headers.entries()) {
          log(`  ${key}: ${value}`);
        }

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP error! status: ${response.status}\n${text}`);
        }

        const blob = await response.blob();
        log(`Received blob: ${blob.size} bytes, type: ${blob.type}`, 'success');
      } catch (error) {
        log(`API Error: ${error.message}`, 'error');
      }
    }

    // Test just audio playback with a test sound
    async function testAudioOnly() {
      try {
        log('Testing audio playback with test tone...');
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        gainNode.gain.value = 0.1; // Quiet volume
        oscillator.frequency.value = 440; // A4 note
        
        log('Starting audio...');
        oscillator.start();
        
        // Play for 1 second
        setTimeout(() => {
          oscillator.stop();
          log('Audio test complete', 'success');
        }, 1000);
      } catch (error) {
        log(`Audio Error: ${error.message}`, 'error');
      }
    }

    // Test the full voice synthesis and playback
    async function testVoice() {
      const apiKey = 'sk_f0273b3cafb56f7270e2ac6f91d37b60b821a99d6a28feef';
      const voiceId = '21m00Tcm4TlvDq8ikWAM';
      const text = 'This is a minimal test of the voice synthesis system.';

      try {
        log('Making API request...');
        const response = await fetch(
          `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`,
          {
            method: 'POST',
            headers: {
              'Accept': 'audio/mpeg',
              'Content-Type': 'application/json',
              'xi-api-key': apiKey
            },
            body: JSON.stringify({
              text,
              model_id: 'eleven_monolingual_v1',
              voice_settings: {
                stability: 0.5,
                similarity_boost: 0.75
              }
            })
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        log('Response received, creating blob...');
        const blob = await response.blob();
        log(`Blob created: ${blob.size} bytes, type: ${blob.type}`);

        const url = URL.createObjectURL(blob);
        const audio = new Audio();
        
        audio.onerror = (e) => {
          log(`Audio error: ${e.target.error?.message || 'Unknown error'}`, 'error');
        };

        audio.oncanplay = () => {
          log('Audio ready to play', 'success');
        };

        audio.onplay = () => {
          log('Audio started playing', 'success');
        };

        audio.onended = () => {
          log('Audio finished playing', 'success');
          URL.revokeObjectURL(url);
        };

        log('Setting audio source...');
        audio.src = url;
        
        log('Starting playback...');
        const playPromise = audio.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => log('Play promise resolved'))
            .catch(error => log(`Play promise rejected: ${error}`, 'error'));
        }

      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Log browser capabilities
    log(`Browser audio support:
- Audio element: ${typeof Audio !== 'undefined'}
- AudioContext: ${typeof (window.AudioContext || window.webkitAudioContext) !== 'undefined'}
- MP3 support: ${new Audio().canPlayType('audio/mpeg')}
- WebM support: ${new Audio().canPlayType('audio/webm')}
- OGG support: ${new Audio().canPlayType('audio/ogg')}
- WAV support: ${new Audio().canPlayType('audio/wav')}`);
  </script>
</body>
</html>